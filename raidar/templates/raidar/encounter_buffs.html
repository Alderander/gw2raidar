{% load staticfiles %}
{% comment %}
XXX Currently, all of the buffs are in a single table, looked up by `data.buff_tabs[5]`
However, there's other five tabs just waiting to happen (according to #216)
Waiting to see how they are to be rendered. Are they switched? What's the switch?
{% endcomment %}

<div class="table-container">
  {% include 'raidar/encounter_row_header.html' %}
  <div class="r-encounter-stats-container uk-background-default" style="z-index: 980;" uk-sticky="bottom: #offset">
    <div class="r-stats-row r-stats-header">
      <div class="uk-visible@m">Spec</div>
      <div class="r-buff-toggle" uk-switcher="connect: .uk-switcher">
        <a href="#">Uptime</a> | <a href="#">Output</a>
      </div>
    </div>
  </div>
  <div class="r-encounter-stats-container">
    <div class="r-stats-row r-stats-buffs">
      <div class="r-encounter-player uk-text-right [[self && 'compare-show']]">
        <div>
            <h5 class="uk-margin-remove">Squad</h5>
        </div>
      </div>
      <ul class="r-encounter-buff-container" >
        <!-- Uptime -->
        <li class="uk-active">
          [[#if persistent_page.tab == 'offensive_boons']]
          [[#each data.buff_tabs[1].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]

          [[elseif persistent_page.tab == 'supportive_boons']]
          [[#each data.buff_tabs[2].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]

          [[elseif persistent_page.tab == 'offensive_buffs']]
          [[#each data.buff_tabs[3].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]

          [[elseif persistent_page.tab == 'supportive_buffs']]
          [[#each data.buff_tabs[3].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]

          [[/if]]

        </li>
      </ul>
    </div>

  [[#each encounter.parties:partyNo]]
  <h5 class="uk-heading-line"><span>Party [[partyNo]]</span></h5>
    [[#each members]]

        <div class="r-stats-row r-stats-buffs">
          <div class="r-encounter-player uk-text-right [[self && 'compare-show']]" uk-tooltip="pos: bottom-left; delay: 350" title="[[#with encounter.phases[page.phase].events]]
            Deaths: [[deaths]][[#if deaths]] ([[formatTime(dead_time / 1000)]])[[/if]]<br>
            Downs: [[downs]][[#if downs]] ([[formatTime(down_time / 1000)]])[[/if]]<br>
            Disconnects: [[disconnects]][[#if disconnects]] ([[formatTime(disconnect_time / 1000)]])[[/if]]<br>
          [[/with]]">
            <div>
              <h6 class="uk-font-family-secondary uk-margin-remove uk-text-uppercase">[[data.archetypes[archetype]]]</h6>
              [[#if name]]
                <h5 class="uk-margin-remove">[[name]]</h5>
              [[else]]
                <h5 class="private uk-margin-remove">PRIVATE</h5>
              [[/if]]
            </div>
            <img alt="[[data.specialisations[profession][elite]]]" src="{% static 'raidar/img/48px/' %}/[[data.specialisations[profession][elite]]]_tango_icon_48px.png"/>

          </div>
          <ul class="uk-switcher r-buff-toggle r-encounter-buff-container" >
            [[#if persistent_page.tab == 'offensive_boons']]
              <!-- Uptime -->
              <li>
                [[#each data.buff_tabs[1].order]]
                  [[#with { buff: data.buffs[.], code: . } ]]
                    [[#if encounter.phases[page.phase]]]
                      <div class="r-encounter-buff">
                        [[#with { format: buff.stacks ? num : perc } ]]
                        <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                          <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                          [[#if encounter.phases[page.phase].group]]
                            <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                          [[/if]]
                        [[/with]]
                      </div>
                    [[else]]
                      <div></div>
                    [[/if]]
                  [[/with]]
                [[/each]]
              </li>
              <!-- Output -->
              <li>
                [[#each data.buff_tabs[1].order]]
                  [[#with { buff: data.buffs[.], code: . } ]]
                    [[#if encounter.phases[page.phase]]]
                      <div class="r-encounter-buff">
                        [[#with { format: buff.stacks ? num : perc } ]]
                        <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                          <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                          [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                            <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                          [[/if]]
                        [[/with]]
                      </div>
                    [[else]]
                      <div></div>
                    [[/if]]
                  [[/with]]
                [[/each]]
              </li>

            [[elseif persistent_page.tab == 'supportive_boons']]
            <!-- Uptime -->
            <li>
              [[#each data.buff_tabs[2].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                        [[#if encounter.phases[page.phase].group]]
                          <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>
            <!-- Output -->
            <li>
              [[#each data.buff_tabs[2].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                        [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                          <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>

            [[elseif persistent_page.tab == 'offensive_buffs']]
            <!-- Uptime -->
            <li>
              [[#each data.buff_tabs[3].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                        [[#if encounter.phases[page.phase].group]]
                          <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>
            <!-- Output -->
            <li>
              [[#each data.buff_tabs[3].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                        [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                          <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>

            [[elseif persistent_page.tab == 'supportive_buffs']]
            <!-- Uptime -->
            <li>
              [[#each data.buff_tabs[4].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                        [[#if encounter.phases[page.phase].group]]
                          <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>
            <!-- Output -->
            <li>
              [[#each data.buff_tabs[4].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if encounter.phases[page.phase]]]
                    <div class="r-encounter-buff">
                      [[#with { format: buff.stacks ? num : perc } ]]
                      <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                        <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                        [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                          <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </div>
                  [[else]]
                    <div></div>
                  [[/if]]
                [[/with]]
              [[/each]]
            </li>
            [[/if]]
          </ul>
        </div>

    [[/each]]
    <div class="r-stats-row r-stats-buffs">
      <div class="r-encounter-player uk-text-right [[self && 'compare-show']]" uk-tooltip="pos: bottom-left; delay: 350" title="[[#with encounter.phases[page.phase].events]]
        Deaths: [[deaths]][[#if deaths]] ([[formatTime(dead_time / 1000)]])[[/if]]<br>
        Downs: [[downs]][[#if downs]] ([[formatTime(down_time / 1000)]])[[/if]]<br>
        Disconnects: [[disconnects]][[#if disconnects]] ([[formatTime(disconnect_time / 1000)]])[[/if]]<br>
      [[/with]]">
        <div>
            <h6 class="uk-font-family-secondary uk-margin-remove uk-text-uppercase">([[members.length]] member[[members.length > 1 && 's' || '']])</h6>
            <h5 class="uk-margin-remove">Party [[partyNo]] </h5>
        </div>

      </div>
      <ul class="uk-switcher r-buff-toggle r-encounter-buff-container" >
        [[#if persistent_page.tab == 'offensive_boons']]
          <!-- Uptime -->
          <li>
            [[#each data.buff_tabs[1].order]]
              [[#with { buff: data.buffs[.], code: . } ]]
                [[#if encounter.phases[page.phase]]]
                  <div class="r-encounter-buff">
                    [[#with { format: buff.stacks ? num : perc } ]]
                    <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                      <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                      [[#if encounter.phases[page.phase].group]]
                        <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                      [[/if]]
                    [[/with]]
                  </div>
                [[else]]
                  <div></div>
                [[/if]]
              [[/with]]
            [[/each]]
          </li>
          <!-- Output -->
          <li>
            [[#each data.buff_tabs[1].order]]
              [[#with { buff: data.buffs[.], code: . } ]]
                [[#if encounter.phases[page.phase]]]
                  <div class="r-encounter-buff">
                    [[#with { format: buff.stacks ? num : perc } ]]
                    <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                      <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                      [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                        <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                      [[/if]]
                    [[/with]]
                  </div>
                [[else]]
                  <div></div>
                [[/if]]
              [[/with]]
            [[/each]]
          </li>

        [[elseif persistent_page.tab == 'supportive_boons']]
        <!-- Uptime -->
        <li>
          [[#each data.buff_tabs[2].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>
        <!-- Output -->
        <li>
          [[#each data.buff_tabs[2].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                    [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                      <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>

        [[elseif persistent_page.tab == 'offensive_buffs']]
        <!-- Uptime -->
        <li>
          [[#each data.buff_tabs[3].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>
        <!-- Output -->
        <li>
          [[#each data.buff_tabs[3].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                    [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                      <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>

        [[elseif persistent_page.tab == 'supportive_buffs']]
        <!-- Uptime -->
        <li>
          [[#each data.buff_tabs[4].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-[[num(((encounter.phases[page.phase].buffs[code])/(encounter.phases[page.phase].group.buffs['max_' + code])*100), 0)]]">[[format(encounter.phases[page.phase].buffs[code], 1)]] </span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="r-buff-number r-bg-50 compare">[[format(encounter.phases[page.phase].group.buffs['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>
        <!-- Output -->
        <li>
          [[#each data.buff_tabs[4].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <div class="r-encounter-buff">
                  [[#with { format: buff.stacks ? num : perc } ]]
                  <img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/>
                    <span class="r-buff-number r-bg-60">[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                    [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                      <span class="r-buff-number r-bg-50 compare">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </div>
              [[else]]
                <div></div>
              [[/if]]
            [[/with]]
          [[/each]]
        </li>
        [[/if]]
      </ul>
    </div>
  [[/each]]
  </div>
  <div class="uk-overflow-auto">
    <table class="uk-table stats">
      <tbody>
        <tr>
          <th>Totals</th>
          [[#each data.buff_tabs[5].order]]
            [[#with { buff: data.buffs[.] } ]]
              <th width="100"><img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/></th>
            [[/with]]
          [[/each]]
        </tr>
        <tr>
          <td>Squad</td>
          [[#each data.buff_tabs[5].order]]
            [[#with { buff: data.buffs[.], code: . } ]]
              [[#if encounter.phases[page.phase]]]
                <td style="[[#if encounter.phases[page.phase].group]][[bar(encounter.phases[page.phase].buffs_out[code], encounter.phases[page.phase].group.buffs_out['avg_' + code], encounter.phases[page.phase].group.buffs_out['min_' + code], encounter.phases[page.phase].group.buffs_out['max_' + code], buff.stacks || 100)]][[else]][[bar1(encounter.phases[page.phase].buffs_out[code], buff.stacks || 100)]][[/if]]">
                  [[#with { format: buff.stacks ? num : perc } ]]
                    <span>[[format(encounter.phases[page.phase].buffs_out[code], 2)]]</span>
                    [[#if encounter.phases[page.phase].group]]
                      <span class="expected">[[format(encounter.phases[page.phase].group.buffs_out['avg_' + code], 2)]]</span>
                    [[/if]]
                  [[/with]]
                </td>
              [[else]]
                <td></td>
              [[/if]]
            [[/with]]
          [[/each]]
        </tr>
        [[#each encounter.parties:partyNo]]
          <tr>
            <td>Party [[partyNo]] ([[members.length]] member[[members.length > 1 && 's' || '']])</td>
            [[#each data.buff_tabs[5].order]]
              [[#with { buff: data.buffs[.], code: . } ]]
                [[#if phases[page.phase]]]
                  <td style="[[bar1(phases[page.phase].buffs_out[code], buff.stacks || 100)]]">
                    [[#with { format: buff.stacks ? num : perc } ]]
                      <span>[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                    [[/with]]
                  </td>
                [[else]]
                  <td></td>
                [[/if]]
              [[/with]]
            [[/each]]
          </tr>
        [[/each]]
      </tbody>

      [[#each encounter.parties:partyNo]]
        <tbody>
          <tr>
            <th>Party [[partyNo]]</th>
            [[#each data.buff_tabs[5].order]]
              [[#with { buff: data.buffs[.] } ]]
                <th width="100"><img src="[[buff.icon]]" uk-tooltip title="[[buff.name]]" alt="[[buff.name]]"/></th>
              [[/with]]
            [[/each]]
          </tr>
          [[#each members]]
            <tr>
              <td class="[[self && 'uk-text-primary']]">
                <img alt="[[data.archetypes[archetype]]]" src="{% static 'raidar/img/arch/' %}/[[data.archetypes[archetype]]].png"/>
                <img alt="[[data.specialisations[profession][elite]]]" src="{% static 'raidar/img/20px/' %}/[[data.specialisations[profession][elite]]]_tango_icon_20px.png"/>
                [[#if name]]
                  [[name]]
                [[else]]
                  <span class="private">PRIVATE</span>
                [[/if]]
              </td>
              [[#each data.buff_tabs[5].order]]
                [[#with { buff: data.buffs[.], code: . } ]]
                  [[#if phases[page.phase]]]
                    <td style="[[#if phases[page.phase].archetype.buffs_out['avg_' + code]]][[bar(phases[page.phase].buffs_out[code], phases[page.phase].archetype.buffs_out['avg_' + code], phases[page.phase].archetype.buffs_out['min_' + code], phases[page.phase].archetype.buffs_out['max_' + code], buff.stacks || 100)]][[else]][[bar1(phases[page.phase].buffs_out[code], buff.stacks || 100)]][[/if]]">
                      [[#with { format: buff.stacks ? num : perc } ]]
                        <span>[[format(phases[page.phase].buffs_out[code], 2)]]</span>
                        [[#if phases[page.phase].archetype.buffs_out['avg_' + code]]]
                          <span class="expected">[[format(phases[page.phase].archetype.buffs_out['avg_' + boon], 2)]]</span>
                        [[/if]]
                      [[/with]]
                    </td>
                  [[else]]
                    <td></td>
                  [[/if]]
                [[/with]]
              [[/each]]
            </tr>
          [[/each]]
        </tbody>
      [[/each]]
    </table>
  </div>
</div>
