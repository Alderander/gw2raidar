{% load staticfiles %}
<div class="uk-grid uk-grid-item-match">
  {# Mobile navigation/filtering #}
  <h6 class="uk-font-family-secondary uk-hidden@s uk-margin-top">Encounter Filter</h6>
  <select class="uk-select uk-hidden@m uk-margin-bottom" as-ukUpdate id="area-selector"  value='[[page.leaderboards.area]]' on-change="leaderboards_nav">
    [[#each data.boss_locations:kind_id]]
      [[#each wings:wing_id]]
        <optgroup label="[[name]]">
          [[#each bosses]]
            <option value='[[{ kind: kind_id, wing: wing_id, boss: .}]]'>[[data.areas[.].name]]</option>
          [[/each]]
        </optgroup>
      [[/each]]
    [[/each]]
  </select>
  <div class="uk-flex-left uk-visible@m " uk-grid>
    <div class="uk-width-expand  uk-margin-bottom uk-margin-top">
      <div class="uk-width-1-1 boundary">
        <div class="uk-button-group ">
          [[#each data.boss_locations:kind_id]]
            [[#with page.leaderboards.area.kind == kind_id as active]]
              <button class="uk-button uk-inline" class-uk-button-primary="active">[[#if active]][[page.leaderboards.area.boss ? data.areas[page.leaderboards.area.boss].name : data.boss_locations[page.leaderboards.area.kind].wings[page.leaderboards.area.wing].name]] &mdash;&nbsp;[[/if]][[name]] <i class="material-icons">expand_more</i></button>
            [[/with]]
            <div uk-dropdown="mode: click; boundary: .boundary; boundary-align: true; pos: bottom-justify;">
              <div class="uk-width-1 uk-grid">
                [[#each wings:wing_id]]
                  <div class="uk-width-1-[[columns]]@m uk-width-1">
                    <ul class="uk-nav uk-dropdown-nav">
                      <li class="uk-link uk-nav-header uk-margin-top" on-click="@this.fire('leaderboards_nav', {}, { kind: kind_id, wing: wing_id })">[[name]]</li>
                      [[#each bosses]]
                        <li on-click="@this.fire('leaderboards_nav', {}, { kind: kind_id, wing: wing_id, boss: . })" class-uk-active="page.leaderboards.area == ."><a>[[data.areas[.].name]]</a></li>
                      [[/each]]
                    </ul>
                  </div>
                [[/each]]
              </div>
            </div>
          [[/each]]
        </div>
      </div>
    </div>
  </div>

  <div class="r-toggle uk-font-family-secondary uk-text-small uk-text-uppercase uk-width-auto@s uk-margin-small-top uk-margin-small-bottom">
     <div uk-form-custom="target: > * > span.era">
         <select value="[[page.era]]" on-change="leaderboards_nav">
           <option value="[[null]]" default>This Era</option>
           <option disabled>──────────</option>
           [[#each leaderboards.eras]]
             <option value="[[id]]">[[name]]</option>
           [[/each]]
         </select>
         <span>
           <span class="era"></span> <i class="material-icons">keyboard_arrow_down</i>
         </span>
     </div>
     |
     <div uk-form-custom="target: > * > span.time">
         <select value="[[page.leaderboards.area.week]]">
             [[#each leaderboards.weeks as week]]
               <option value="[[week]]">[[formatDate(week, true)]]</option>
             [[/each]]
         </select>
         <span>
             <span class="uk-active">Fastest Kills</span> <span class="uk-active time"></span> <i class="material-icons">keyboard_arrow_down</i>
         </span>
     </div>
  </div>

</div>
<!-- Note: The toggle system doesn't really work the way I want but I couldn't find a better way to mock it up. I'd like to have it so that clicking on the default "encounter" element adds the .expanded class to the whole element and shows the "close" icon, ideally clicking on that would close that element. Currently clicking anywhere on the "expanded" element will close it, which isn't ideal because we want people to be able to click through to encounters. -->
<div class="r-leaderboard-wing">
  <!-- Switch for CM included only for those wings that have CM. Otherwise just have text. -->
  <div class="r-toggle uk-h3 uk-font-family-secondary r-leaderboard-heading uk-margin-remove uk-text-uppercase">
    [[data.boss_locations[page.leaderboards.area.kind].name]] -
    [[data.boss_locations[page.leaderboards.area.kind].wings[page.leaderboards.area.wing].name]]
  </div>
  [[#each data.boss_locations[page.leaderboards.area.kind].wings[page.leaderboards.area.wing].bosses as boss]]
    [[#with leaderboards[boss].weekly[page.leaderboards.area.week] as weekly]]
      <div class="r-leaderboard-encounter" class-expanded="boss == page.leaderboards.area.boss" on-click="@this.set('page.leaderboards.area.boss', boss)">
        <img src="/static/raidar/img/icon/[[data.areas[boss].name]].png" alt="">
        <h2 class="uk-margin-remove-bottom ">[[data.areas[boss].name]]</h2>
        <a class="uk-h3 uk-margin-remove" class-uk-invisible="boss != page.leaderboards.area.boss" on-click="@this.set('page.leaderboards.area.boss', null) && false"><i class="material-icons">close</i></a>
        [[#each weekly['duration'] as line]]
        <div class="r-leaderboard-row">
          <div class="r-damage">
            <svg class="chart" width="100%" xmlns='http://www.w3.org/2000/svg' height="100%" xml:space="preserve" preserveAspectRatio="xMinYMax meet">
              <!-- Same as our other rect graphs -->
              <rect class="chart total r-bg-101"  x='0' y='18px' height='16px' width='[[100 * line.dps / weekly.max_max_dps]]%' opacity='0.3' />
              <rect class="chart boss r-bg-101" x='0' y='18px' height='16px' width='[[100 * line.dps_boss / weekly.max_max_dps]]%'/>

              <!-- Ranking -->
              <text class="rank" x="0" y="28px" dominant-baseline="middle" text-anchor="begin" font-family="Source Sans Pro" font-weight="900" font-size="80">[[@index + 1]]</text>

              <!-- Encounter Duration -->
              <text class="duration" x="48px" y="8px" dominant-baseline="middle" text-anchor="begin" font-family="Source Sans Pro" font-weight="900" fill="rgba(255, 255, 255, 0.8)" font-size="20">[[formatTime(line.duration)]]</text>

              <!-- Encounter DPS (Boss) Total like it is on Global Stats -->
              <text class="dps" x="48px" y="27px" dominant-baseline="middle" text-anchor="begin" font-family="Source Code Pro" fill="#15141e" font-weight="400" font-size="12">([[num(line.dps_boss, 0)]]) [[num(line.dps, 0)]] DPS</text>
            </svg>
          </div>
          <div class="r-buffs">
            [[#each ['might', 'fury', 'quickness', 'alacrity'] as buff]]
              [[#with data.buffs[buff].name as name, data.buffs[buff].stacks ? num : perc as format]]
                <div class="r-buff">
                  <div class="r-buff-icon">
                    <img src="{% static 'raidar/img/buff/' %}/[[name]].png" alt="[[name]]" width="20">
                  </div>
                  <div class="r-buff-number r-bg-101">[[format(line.buffs[buff], 2)]]</div>
                </div>
              [[/with]]
            [[/each]]
          </div>
          <div class="r-composition">
            [[#each line.comp as member]]
              [[#with data.archetypes[member[0]] as arch, data.specialisations[member[1]][member[2]] as spec]]
                <img alt="[[arch]] [[spec]]" src="/static/raidar/img/48px/[[spec]]_tango_icon_48px.png">
              [[/with]]
            [[/each]]
          </div>
        </div>
      [[/each]]
    [[/with]]
  [[/each]]


</div>
